#!/usr/bin/env ruby
# frozen_string_literal: true

# vim: set syntax=ruby

# kettle-changelog: Generate a CHANGELOG.md entry for the current VERSION.
# - Reads VERSION from lib/**/version.rb (must be unique across files)
# - Moves entries from the "Unreleased" section into a new versioned section
# - Prepends 4 heading lines:
#   - TAG
#   - COVERAGE (line coverage)
#   - BRANCH COVERAGE (branch coverage)
#   - percent documented (parsed from `bin/yard` output)
# - Updates bottom link references to GitHub style, converts any existing
#   GitLab links to GitHub links, and appends the new [X.Y.Z] and [X.Y.Zt] links.
#
# Notes:
# - Expects a JSON coverage report at coverage/coverage.json. If missing,
#   it will instruct you to run: K_SOUP_COV_FORMATTERS="json" bin/rspec
# - Expects bin/yard to be available via Bundler.

$stdout.sync = true

# Do not rely on Bundler; allow running in repos that do not depend on kettle-dev
# Ensure RubyGems is available for 'require' lookups
begin
  require "rubygems"
rescue LoadError
  # Older Rubies always have rubygems; continue anyway
end

script_basename = File.basename(__FILE__)

begin
  # Standard library
  require "json"
  require "time"
  require "open3"
  require "shellwords"

  # This library
  require "kettle/dev"
  puts "== #{script_basename} v#{Kettle::Dev::Version::VERSION} =="
rescue LoadError => e
  warn("#{script_basename}: could not load dependency: #{e.class}: #{e.message}")
  warn("Hint: Ensure the host project has kettle-dev as a dependency and run bundle install.")
  exit(1)
end

begin
  if ARGV.include?("-h") || ARGV.include?("--help")
    puts <<~USAGE
      Usage: kettle-changelog [--no-strict]

      Generates a new CHANGELOG.md entry for the current version detected from lib/**/version.rb.
      Moves entries from [Unreleased] into the new section, adds coverage and documentation stats,
      and updates bottom link references to GitHub style, adding new compare/tag links.

      Options:
        --no-strict               Allow missing coverage and yard data (warnings only, no errors)

      Environment:
        K_CHANGELOG_STRICT=false  Disable strict mode (equivalent to --no-strict flag)

      Prerequisites:
        - coverage/coverage.json present (run: bin/rake coverage to generate)
        - yard installed and available via bin/yard

      By default (strict mode), if coverage.json or yard stats are missing, the script will:
        1. Attempt to generate them by running bin/rake coverage and bin/rake yard
        2. Fail with an error if generation fails or data is still unavailable

      Use --no-strict or K_CHANGELOG_STRICT=false to allow missing data (backward compatible behavior).
    USAGE
    exit(0)
  end
end

begin
  # Determine if strict mode is enabled (default: true)
  strict_mode = !ARGV.include?("--no-strict") && ENV.fetch("K_CHANGELOG_STRICT", "true").downcase != "false"

  Kettle::Dev::ChangelogCLI.new(strict: strict_mode).run
rescue LoadError => e
  warn("#{script_basename}: could not load dependency: #{e.class}: #{e.message}")
  warn(e.backtrace.join("\n")) if ENV["DEBUG"]
  exit(1)
rescue SystemExit => e
  # Preserve exit status, but ensure at least a newline so shells don't show an empty line only.
  warn("#{script_basename}: exited (status=#{e.status}, msg=#{e.message})") if e.status != 0
  raise
rescue StandardError => e
  warn("#{script_basename}: unexpected error: #{e.class}: #{e.message}")
  warn(e.backtrace.join("\n"))
  exit(1)
end
