<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: STEP_3_RESULT
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "STEP_3_RESULT";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: STEP_3_RESULT</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="step-3-result--source-merger-specification">Step 3 Result â€” Source Merger Specification</h1>

<p>This documents the design for <code>lib/kettle/dev/source_merger.rb</code>, covering parser/unparser usage, strategies, freeze markers, and failure handling.</p>

<h2 id="primary-responsibilities">Primary Responsibilities</h2>
<ul>
  <li>Provide an API (e.g., <code>SourceMerger.merge(source:, destination:, strategy:, path:)</code>) that receives template content, existing destination content, the strategy from <code>template_manifest.yml</code>, and a path identifier for logging/errors.</li>
  <li>Parse both source and destination Ruby via <code>Parser::CurrentRuby</code> into ASTs while retaining <code>Parser::Source::Buffer</code> objects for rewriter context.</li>
  <li>Use <code>Parser::Source::TreeRewriter</code> (or <code>Parser::TreeRewriter</code>) for localized edits, then run <code>Unparser.unparse(ast)</code> or <code>Unparser.dump</code> to emit Ruby that reflects AST changes while preserving formatting as much as unparser allows.</li>
  <li>Detect and honor <code>kettle-dev:freeze</code> / <code>kettle-dev:unfreeze</code> comment pairs by splitting the file into segments; AST edits run only on unprotected segments, while frozen segments are spliced back untouched.</li>
  <li>Inject the universal reminder comment block at the top of every Ruby target (if not already present):
    <pre class="code language-ruby"><code class="language-ruby"># To retain during kettle-dev templating:
#     kettle-dev:freeze
#     # ... your code
#     kettle-dev:unfreeze
</code></pre>
  </li>
</ul>

<h2 id="strategy-behavior">Strategy Behavior</h2>
<ul>
  <li>
<code>skip</code>: bypass AST manipulation entirely (legacy behavior). Still ensure the reminder comment exists before content is returned to <code>TemplateHelpers</code>.</li>
  <li>
<code>replace</code>: swap unprotected destination segments with source AST output; frozen regions are preserved verbatim. Useful for files where template owns structure.</li>
  <li>
<code>append</code>: identify gem declarations (<code>send</code> nodes with <code>:gem</code>, <code>:git_source</code>, <code>:source</code>, etc.) in the source AST and append missing ones to the destination AST while leaving existing nodes (and order) untouched outside frozen segments.</li>
  <li>
<code>merge</code>: the most comprehensive strategy: reconcile <code>source</code> statements, <code>git_source</code> definitions (by name), <code>gem</code> entries (avoid duplicates, update version constraints if template differs), and general statements such as helper method definitions. Should maintain original ordering heuristics (e.g., <code>source</code> before <code>git_source</code>, gem declarations grouped) while keeping comments and other code.</li>
</ul>

<h2 id="error-handling">Error Handling</h2>
<ul>
  <li>Any parser/rewriter/unparser exception must be rescued, emit a message such as:
    <blockquote>
      <p><code>ERROR: kettle-dev templating failed for &lt;path&gt;. Please file a bug at https://github.com/kettle-rb/kettle-dev/issues with the offending file.</code></p>
    </blockquote>
  </li>
  <li>After printing, re-raise as <code>Kettle::Dev::Error</code> (wrapping the original) so the template task aborts. No regex or direct-copy fallback is allowed once a file uses an AST strategy.</li>
</ul>

<h2 id="integration-hooks">Integration Hooks</h2>
<ul>
  <li>Expose a helper (<code>SourceMerger.apply(strategy:, src:, dest:, path:)</code>) callable from <code>TemplateHelpers.copy_file_with_prompt</code> after token replacements but before write.</li>
  <li>Provide an option to skip parsing when the destination file is missing (e.g., treat missing dest as empty string) so <code>replace</code>/<code>merge</code> can still run.</li>
  <li>Include detection to avoid duplicating the reminder comment if it already exists at the top of the destination file.</li>
</ul>

<h2 id="testing-targets">Testing Targets</h2>
<ul>
  <li>Dedicated spec file (e.g., <code>spec/kettle/dev/source_merger_spec.rb</code>) covering:
    <ul>
      <li>Freeze block preservation across strategies.</li>
      <li>
<code>append</code> adding missing gem declarations without duplicating existing ones or disturbing comments.</li>
      <li>
<code>merge</code> reconciling <code>source</code>/<code>git_source</code>/gem statements with interleaved Ruby helpers (e.g., <code>home = ENV[...]</code>).</li>
      <li>Error-raising behavior when parsing invalid Ruby.</li>
    </ul>
  </li>
</ul>

<p>With this spec in place, Step 4 can implement manifest-aware helper plumbing and the SourceMerger itself.</p>
</div></div>

      <div id="footer">
  Generated on Thu Nov 27 03:36:46 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.7).
</div>

    </div>
  </body>
</html>