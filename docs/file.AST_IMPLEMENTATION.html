<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: AST_IMPLEMENTATION
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "AST_IMPLEMENTATION";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: AST_IMPLEMENTATION</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="ast-based-template-implementation-plan">AST-Based Template Implementation Plan</h1>

<h2 id="1-catalog-existing-template-targets">1. Catalog Existing Template Targets</h2>
<ul>
  <li>Review <code>lib/kettle/dev/template_helpers.rb</code> to inventory every file copied by <code>copy_file_with_prompt</code>, noting which are Ruby files (e.g., <code>Gemfile</code>, <code>Rakefile</code>, gemspecs) versus plain text/Markdown.</li>
  <li>Review <code>lib/kettle/dev/modular_gemfiles.rb</code> to list modular <code>.gemfile</code> targets and modular subdirectories.</li>
  <li>Record existing merge logic (e.g., <code>merge_gemfile_dependencies</code>, Appraisals carry-over) and candidate files for AST merging.</li>
  <li>Outcome: a definitive list of templated Ruby paths/globs to populate the manifest.</li>
</ul>

<h2 id="2-introduce-template_manifestyml">2. Introduce <code>template_manifest.yml</code>
</h2>
<ul>
  <li>Create a root-level YAML file describing all templated paths.</li>
  <li>Schema per entry:<br>
```yaml
    <ul>
      <li>path: “Gemfile”        # string path or glob relative to project root<br>
strategy: skip          # enum: skip|replace|append|merge<br>
```</li>
    </ul>
  </li>
  <li>Order entries so glob patterns appear before concrete paths; enforce this when loading.</li>
  <li>Initialize all entries with <code>strategy: skip</code> to stage incremental migration.</li>
  <li>Keep room for future metadata by allowing optional keys (e.g., <code>notes</code>, <code>priority</code>) though none are used yet.</li>
</ul>

<h2 id="3-implement-kettledevsourcemerger">3. Implement <code>Kettle::Dev::SourceMerger</code>
</h2>
<ul>
  <li>File: <code>lib/kettle/dev/source_merger.rb</code>.</li>
  <li>Responsibilities:
    <ul>
      <li>Parse template and destination Ruby via <code>Parser::CurrentRuby.parse</code> with <code>Parser::Source::Buffer</code>.</li>
      <li>Use <code>Parser::TreeRewriter</code>/<code>Parser::TreeWriter</code> patterns plus <code>Unparser</code> to emit Ruby while preserving formatting.</li>
      <li>Support strategies:
        <ul>
          <li>
<code>skip</code>: return destination untouched after inserting the universal freeze reminder.</li>
          <li>
<code>replace</code>: replace destination AST (outside protected regions) with template AST.</li>
          <li>
<code>append</code>: add nodes (e.g., missing <code>gem</code> declarations) without modifying existing nodes.</li>
          <li>
<code>merge</code>: reconcile nodes (sources, <code>git_source</code>, gem specs, etc.) combining template + destination semantics.</li>
        </ul>
      </li>
      <li>Honor magic comments <code># kettle-dev:freeze</code> and <code># kettle-dev:unfreeze</code> (case-insensitive) to leave protected regions untouched regardless of strategy.</li>
      <li>On any parser/rewriter error, rescue, emit a bug-report prompt instructing the user to file an issue, then re-raise the original exception (no fallback writes).</li>
    </ul>
  </li>
</ul>

<h2 id="4-manifest-aware-copy-flow">4. Manifest-Aware Copy Flow</h2>
<ul>
  <li>Extend <code>TemplateHelpers</code> with methods to load and query <code>template_manifest.yml</code>, resolving glob entries first.</li>
  <li>Update <code>copy_file_with_prompt</code> to:
    <ul>
      <li>Detect Ruby targets (via manifest association) and prepend the freeze reminder comment block:
        <pre class="code language-ruby"><code class="language-ruby"># To retain during kettle-dev templating:
#     kettle-dev:freeze
#     # ... your code
#     kettle-dev:unfreeze
</code></pre>
      </li>
      <li>Apply existing token replacements (unchanged behavior).</li>
      <li>When strategy ≠ <code>skip</code>, route template/destination content through <code>SourceMerger</code> before writing.</li>
      <li>Continue honoring <code>allow_create</code> / <code>allow_replace</code> prompts and <code>.example</code> preferences.</li>
    </ul>
  </li>
  <li>Update <code>ModularGemfiles.sync!</code> to pass through the manifest-based logic instead of directly copying strings, ensuring modular gemfiles also get the freeze reminder and AST merge behavior.</li>
</ul>

<h2 id="5-testing">5. Testing</h2>
<ul>
  <li>Add specs under <code>spec/kettle/dev/source_merger_spec.rb</code> (or similar) covering strategy behavior:
    <ul>
      <li>
<code>skip</code> retains destination content while adding the reminder comment.</li>
      <li>
<code>replace</code> rewrites content but preserves <code>kettle-dev:freeze</code> regions.</li>
      <li>
<code>append</code> adds missing gem declarations without duplicating existing ones and keeps comments/conditionals.</li>
      <li>
<code>merge</code> reconciles <code>source</code>, <code>git_source</code>, and <code>gem</code> entries akin to the previous regex merger.</li>
    </ul>
  </li>
  <li>Update <code>spec/kettle/dev/template_helpers_spec.rb</code> to assert manifest integration (e.g., Ruby file writes gain the reminder comment, and strategy lookups drive the merger hooks).</li>
  <li>Include fixtures representing gemfiles, gemspecs, and modular files containing comments, magic comments, and helper Ruby to verify preservation.</li>
</ul>

<h2 id="6-documentation">6. Documentation</h2>
<ul>
  <li>In <code>README.md</code>:
    <ul>
      <li>Introduce the manifest concept, its location, strategy enum definitions, and the glob-first rule.</li>
      <li>Document the universal freeze reminder block and the <code>kettle-dev:freeze</code>/<code>kettle-dev:unfreeze</code> markers’ semantics.</li>
      <li>Call out the parser/unparser dependency and the fail-hard behavior (errors prompt a bug report and abort the template run).</li>
      <li>Provide guidance for migrating a file from <code>skip</code> to another strategy (update manifest entry, add tests, run template task).</li>
    </ul>
  </li>
</ul>

<h2 id="7-migration-workflow">7. Migration Workflow</h2>
<ul>
  <li>After infrastructure lands, gradually flip manifest entries from <code>skip</code> to <code>merge</code>/<code>append</code>/<code>replace</code> as behaviors are verified.</li>
  <li>Each migration PR should:
    <ul>
      <li>Update the manifest entry.</li>
      <li>Add/expand tests covering the specific file’s scenario.</li>
      <li>Ensure template outputs retain project-specific Ruby (comments, conditionals, helper methods) as verified via specs.</li>
    </ul>
  </li>
</ul>
</div></div>

      <div id="footer">
  Generated on Wed Nov 26 13:41:17 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.7).
</div>

    </div>
  </body>
</html>