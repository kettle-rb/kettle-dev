<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Kettle::Dev::PrismGemfile
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Kettle::Dev::PrismGemfile";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span>
     &raquo; 
    <span class="title">PrismGemfile</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Kettle::Dev::PrismGemfile
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/kettle/dev/prism_gemfile.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Prism helpers for Gemfile-like merging.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#filter_to_top_level_gems-class_method" title="filter_to_top_level_gems (class method)">.<strong>filter_to_top_level_gems</strong>(content)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Filter source content to only include top-level gem-related calls Excludes gems inside groups, conditionals, blocks, etc.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#merge_gem_calls-class_method" title="merge_gem_calls (class method)">.<strong>merge_gem_calls</strong>(src_content, dest_content)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Merge gem calls from src_content into dest_content.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_gem_dependency-class_method" title="remove_gem_dependency (class method)">.<strong>remove_gem_dependency</strong>(content, gem_name)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Remove gem calls that reference the given gem name (to prevent self-dependency).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_github_git_source-class_method" title="remove_github_git_source (class method)">.<strong>remove_github_git_source</strong>(content)  &#x21d2; String </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Remove git_source(:github) from content to allow template git_sources to replace it.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="filter_to_top_level_gems-class_method">
  
    .<strong>filter_to_top_level_gems</strong>(content)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Filter source content to only include top-level gem-related calls<br />
Excludes gems inside groups, conditionals, blocks, etc.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kettle/dev/prism_gemfile.rb', line 73</span>

<span class='kw'>def</span> <span class='id identifier rubyid_filter_to_top_level_gems'>filter_to_top_level_gems</span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_parse_result'>parse_result</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_with_comments'><span class='object_link'><a href="PrismUtils.html#parse_with_comments-class_method" title="Kettle::Dev::PrismUtils.parse_with_comments (method)">parse_with_comments</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_content'>content</span> <span class='kw'>unless</span> <span class='id identifier rubyid_parse_result'>parse_result</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>

  <span class='comment'># Extract only top-level statements (not nested in blocks)
</span>  <span class='id identifier rubyid_top_level_stmts'>top_level_stmts</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_statements'><span class='object_link'><a href="PrismUtils.html#extract_statements-class_method" title="Kettle::Dev::PrismUtils.extract_statements (method)">extract_statements</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_parse_result'>parse_result</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_statements'>statements</span><span class='rparen'>)</span>

  <span class='comment'># Filter to only SIMPLE gem-related calls (not blocks, conditionals, etc.)
</span>  <span class='comment'># We want to exclude:
</span>  <span class='comment'># - group { ... } blocks (CallNode with a block)
</span>  <span class='comment'># - if/unless conditionals (IfNode, UnlessNode)
</span>  <span class='comment'># - any other compound structures
</span>  <span class='id identifier rubyid_filtered_stmts'>filtered_stmts</span> <span class='op'>=</span> <span class='id identifier rubyid_top_level_stmts'>top_level_stmts</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_stmt'>stmt</span><span class='op'>|</span>
    <span class='comment'># Skip blocks (group, if, unless, etc.)
</span>    <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>IfNode</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>UnlessNode</span><span class='rparen'>)</span>

    <span class='comment'># Only process CallNodes
</span>    <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>CallNode</span><span class='rparen'>)</span>

    <span class='comment'># Skip calls that have blocks (like `group :development do ... end`),
</span>    <span class='comment'># but allow `git_source` which is commonly defined with a block.
</span>    <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_block'>block</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>!=</span> <span class='symbol'>:git_source</span>

    <span class='comment'># Only include gem-related methods
</span>    <span class='lbracket'>[</span><span class='symbol'>:gem</span><span class='comma'>,</span> <span class='symbol'>:source</span><span class='comma'>,</span> <span class='symbol'>:git_source</span><span class='comma'>,</span> <span class='symbol'>:eval_gemfile</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_filtered_stmts'>filtered_stmts</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='comment'># Build filtered content by extracting slices with proper newlines.
</span>  <span class='comment'># Preserve inline comments that Prism separates into comment nodes.
</span>  <span class='id identifier rubyid_filtered_stmts'>filtered_stmts</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_stmt'>stmt</span><span class='op'>|</span>
    <span class='id identifier rubyid_src'>src</span> <span class='op'>=</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='period'>.</span><span class='id identifier rubyid_slice'>slice</span><span class='period'>.</span><span class='id identifier rubyid_rstrip'>rstrip</span>
    <span class='id identifier rubyid_inline'>inline</span> <span class='op'>=</span> <span class='kw'>begin</span>
      <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_inline_comments_for_node'><span class='object_link'><a href="PrismUtils.html#inline_comments_for_node-class_method" title="Kettle::Dev::PrismUtils.inline_comments_for_node (method)">inline_comments_for_node</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_parse_result'>parse_result</span><span class='comma'>,</span> <span class='id identifier rubyid_stmt'>stmt</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span>
      <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_inline'>inline</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_inline'>inline</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>
      <span class='comment'># append inline comments (they already include leading `#` and spacing)
</span>      <span class='id identifier rubyid_src'>src</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_inline'>inline</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:slice</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:strip</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_src'>src</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='comment'># If filtering fails, return original content
</span>  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:debug_error</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug_error'><span class='object_link'><a href="../Dev.html#debug_error-class_method" title="Kettle::Dev.debug_error (method)">debug_error</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_content'>content</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="merge_gem_calls-class_method">
  
    .<strong>merge_gem_calls</strong>(src_content, dest_content)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Merge gem calls from src_content into dest_content.</p>
<ul>
  <li>Replaces dest <code>source</code> call with srcâ€™s if present.</li>
  <li>Replaces or inserts non-comment <code>git_source</code> definitions.</li>
  <li>Appends missing <code>gem</code> calls (by name) from src to dest preserving dest content and newlines.<br />
Uses Prism::Merge with pre-filtering to only merge top-level statements.</li>
</ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kettle/dev/prism_gemfile.rb', line 14</span>

<span class='kw'>def</span> <span class='id identifier rubyid_merge_gem_calls'>merge_gem_calls</span><span class='lparen'>(</span><span class='id identifier rubyid_src_content'>src_content</span><span class='comma'>,</span> <span class='id identifier rubyid_dest_content'>dest_content</span><span class='rparen'>)</span>
  <span class='comment'># Lazy load prism-merge (Ruby 2.7+ requirement)
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prism/merge</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>Merge</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>LoadError</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>] prism-merge gem not available, returning dest_content</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_dest_content'>dest_content</span>
  <span class='kw'>end</span>

  <span class='comment'># Pre-filter: Extract only top-level gem-related calls from src
</span>  <span class='comment'># This prevents nested gems (in groups, conditionals) from being added
</span>  <span class='id identifier rubyid_src_filtered'>src_filtered</span> <span class='op'>=</span> <span class='id identifier rubyid_filter_to_top_level_gems'>filter_to_top_level_gems</span><span class='lparen'>(</span><span class='id identifier rubyid_src_content'>src_content</span><span class='rparen'>)</span>

  <span class='comment'># Always remove :github git_source from dest as it&#39;s built-in to Bundler
</span>  <span class='id identifier rubyid_dest_processed'>dest_processed</span> <span class='op'>=</span> <span class='id identifier rubyid_remove_github_git_source'>remove_github_git_source</span><span class='lparen'>(</span><span class='id identifier rubyid_dest_content'>dest_content</span><span class='rparen'>)</span>

  <span class='comment'># Custom signature generator that normalizes string quotes to prevent
</span>  <span class='comment'># duplicates when gem &quot;foo&quot; and gem &#39;foo&#39; are present.
</span>  <span class='id identifier rubyid_signature_generator'>signature_generator</span> <span class='op'>=</span> <span class='tlambda'>-&gt;</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='rparen'>)</span> <span class='kw'>do</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>CallNode</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='kw'>unless</span> <span class='lbracket'>[</span><span class='symbol'>:gem</span><span class='comma'>,</span> <span class='symbol'>:source</span><span class='comma'>,</span> <span class='symbol'>:git_source</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>

    <span class='comment'># For source(), there should only be one, so signature is just [:source]
</span>    <span class='kw'>return</span> <span class='lbracket'>[</span><span class='symbol'>:source</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbol'>:source</span>

    <span class='id identifier rubyid_first_arg'>first_arg</span> <span class='op'>=</span> <span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_first'>first</span>

    <span class='comment'># Normalize string quotes using unescaped value
</span>    <span class='id identifier rubyid_arg_value'>arg_value</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_first_arg'>first_arg</span>
    <span class='kw'>when</span> <span class='const'>Prism</span><span class='op'>::</span><span class='const'>StringNode</span>
      <span class='id identifier rubyid_first_arg'>first_arg</span><span class='period'>.</span><span class='id identifier rubyid_unescaped'>unescaped</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>when</span> <span class='const'>Prism</span><span class='op'>::</span><span class='const'>SymbolNode</span>
      <span class='id identifier rubyid_first_arg'>first_arg</span><span class='period'>.</span><span class='id identifier rubyid_unescaped'>unescaped</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_arg_value'>arg_value</span> <span class='op'>?</span> <span class='lbracket'>[</span><span class='id identifier rubyid_node'>node</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_arg_value'>arg_value</span><span class='rbracket'>]</span> <span class='op'>:</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='comment'># Use Prism::Merge with template preference for source/git_source replacement
</span>  <span class='id identifier rubyid_merger'>merger</span> <span class='op'>=</span> <span class='const'>Prism</span><span class='op'>::</span><span class='const'>Merge</span><span class='op'>::</span><span class='const'>SmartMerger</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
    <span class='id identifier rubyid_src_filtered'>src_filtered</span><span class='comma'>,</span>
    <span class='id identifier rubyid_dest_processed'>dest_processed</span><span class='comma'>,</span>
    <span class='label'>signature_match_preference:</span> <span class='symbol'>:template</span><span class='comma'>,</span>
    <span class='label'>add_template_only_nodes:</span> <span class='kw'>true</span><span class='comma'>,</span>
    <span class='label'>signature_generator:</span> <span class='id identifier rubyid_signature_generator'>signature_generator</span><span class='comma'>,</span>
  <span class='rparen'>)</span>
  <span class='id identifier rubyid_merger'>merger</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span>
<span class='kw'>rescue</span> <span class='const'>Prism</span><span class='op'>::</span><span class='const'>Merge</span><span class='op'>::</span><span class='const'>Error</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='comment'># Use debug_log if available, otherwise Kettle::Dev.debug_error
</span>  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:debug_error</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug_error'><span class='object_link'><a href="../Dev.html#debug_error-class_method" title="Kettle::Dev.debug_error (method)">debug_error</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>] Prism::Merge failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_dest_content'>dest_content</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_gem_dependency-class_method">
  
    .<strong>remove_gem_dependency</strong>(content, gem_name)  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Remove gem calls that reference the given gem name (to prevent self-dependency).<br />
Works by locating gem() call nodes where the first argument matches gem_name.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>content</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Gemfile-like content</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>gem_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the gem name to remove</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>modified content with self-referential gem calls removed</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kettle/dev/prism_gemfile.rb', line 161</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_gem_dependency'>remove_gem_dependency</span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='comma'>,</span> <span class='id identifier rubyid_gem_name'>gem_name</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_content'>content</span> <span class='kw'>if</span> <span class='id identifier rubyid_gem_name'>gem_name</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_with_comments'><span class='object_link'><a href="PrismUtils.html#parse_with_comments-class_method" title="Kettle::Dev::PrismUtils.parse_with_comments (method)">parse_with_comments</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_stmts'>stmts</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_statements'><span class='object_link'><a href="PrismUtils.html#extract_statements-class_method" title="Kettle::Dev::PrismUtils.extract_statements (method)">extract_statements</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_statements'>statements</span><span class='rparen'>)</span>

  <span class='comment'># Find gem call nodes where first argument matches gem_name
</span>  <span class='id identifier rubyid_gem_nodes'>gem_nodes</span> <span class='op'>=</span> <span class='id identifier rubyid_stmts'>stmts</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>CallNode</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbol'>:gem</span>

    <span class='id identifier rubyid_first_arg'>first_arg</span> <span class='op'>=</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_first'>first</span>
    <span class='id identifier rubyid_arg_val'>arg_val</span> <span class='op'>=</span> <span class='kw'>begin</span>
      <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_literal_value'><span class='object_link'><a href="PrismUtils.html#extract_literal_value-class_method" title="Kettle::Dev::PrismUtils.extract_literal_value (method)">extract_literal_value</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_first_arg'>first_arg</span><span class='rparen'>)</span>
    <span class='kw'>rescue</span> <span class='const'>StandardError</span>
      <span class='kw'>nil</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_arg_val'>arg_val</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_arg_val'>arg_val</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>==</span> <span class='id identifier rubyid_gem_name'>gem_name</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='kw'>end</span>

  <span class='comment'># Remove each matching gem call from content
</span>  <span class='id identifier rubyid_out'>out</span> <span class='op'>=</span> <span class='id identifier rubyid_content'>content</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='id identifier rubyid_gem_nodes'>gem_nodes</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_gn'>gn</span><span class='op'>|</span>
    <span class='comment'># Remove the entire line(s) containing this node
</span>    <span class='id identifier rubyid_out'>out</span> <span class='op'>=</span> <span class='id identifier rubyid_out'>out</span><span class='period'>.</span><span class='id identifier rubyid_sub'>sub</span><span class='lparen'>(</span><span class='id identifier rubyid_gn'>gn</span><span class='period'>.</span><span class='id identifier rubyid_slice'>slice</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_out'>out</span>
<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:debug_error</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug_error'><span class='object_link'><a href="../Dev.html#debug_error-class_method" title="Kettle::Dev.debug_error (method)">debug_error</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_warn'>warn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid___method__'>__method__</span><span class='embexpr_end'>}</span><span class='tstring_content'>] </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_content'>content</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_github_git_source-class_method">
  
    .<strong>remove_github_git_source</strong>(content)  &#x21d2; <tt>String</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Remove git_source(:github) from content to allow template git_sources to replace it.<br />
This is special handling because :github is the default and templates typically<br />
want to replace it with their own git_source definitions.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>content</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Gemfile-like content</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>content with git_source(:github) removed</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/kettle/dev/prism_gemfile.rb', line 131</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_github_git_source'>remove_github_git_source</span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_parse_with_comments'><span class='object_link'><a href="PrismUtils.html#parse_with_comments-class_method" title="Kettle::Dev::PrismUtils.parse_with_comments (method)">parse_with_comments</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_content'>content</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_content'>content</span> <span class='kw'>unless</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>

  <span class='id identifier rubyid_stmts'>stmts</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="PrismUtils.html" title="Kettle::Dev::PrismUtils (module)">PrismUtils</a></span></span><span class='period'>.</span><span class='id identifier rubyid_extract_statements'><span class='object_link'><a href="PrismUtils.html#extract_statements-class_method" title="Kettle::Dev::PrismUtils.extract_statements (method)">extract_statements</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid_statements'>statements</span><span class='rparen'>)</span>

  <span class='comment'># Find git_source(:github) node
</span>  <span class='id identifier rubyid_github_node'>github_node</span> <span class='op'>=</span> <span class='id identifier rubyid_stmts'>stmts</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span>
    <span class='kw'>next</span> <span class='kw'>false</span> <span class='kw'>unless</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>CallNode</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>==</span> <span class='symbol'>:git_source</span>

    <span class='id identifier rubyid_first_arg'>first_arg</span> <span class='op'>=</span> <span class='id identifier rubyid_n'>n</span><span class='period'>.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_arguments'>arguments</span><span class='op'>&amp;.</span><span class='id identifier rubyid_first'>first</span>
    <span class='id identifier rubyid_first_arg'>first_arg</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Prism</span><span class='op'>::</span><span class='const'>SymbolNode</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_first_arg'>first_arg</span><span class='period'>.</span><span class='id identifier rubyid_unescaped'>unescaped</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>github</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_content'>content</span> <span class='kw'>unless</span> <span class='id identifier rubyid_github_node'>github_node</span>

  <span class='comment'># Remove the node&#39;s slice from content
</span>  <span class='id identifier rubyid_content'>content</span><span class='period'>.</span><span class='id identifier rubyid_sub'>sub</span><span class='lparen'>(</span><span class='id identifier rubyid_github_node'>github_node</span><span class='period'>.</span><span class='id identifier rubyid_slice'>slice</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>if</span> <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:debug_error</span><span class='rparen'>)</span>
    <span class='const'><span class='object_link'><a href="../../Kettle.html" title="Kettle (module)">Kettle</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Dev.html" title="Kettle::Dev (module)">Dev</a></span></span><span class='period'>.</span><span class='id identifier rubyid_debug_error'><span class='object_link'><a href="../Dev.html#debug_error-class_method" title="Kettle::Dev.debug_error (method)">debug_error</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_e'>e</span><span class='comma'>,</span> <span class='id identifier rubyid___method__'>__method__</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_content'>content</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Dec  5 13:45:04 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.7).
</div>

    </div>
  </body>
</html>